<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Tyro Payments Integration</title>
   <style>
      .hidden {
         display: none;
      }
   </style>
   <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
   <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
   <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>

<body>
   <input id="type" name="type" type="hidden" value="purchase">
   <main class="container-fluid mt-3">
      <h2 class="fw-bold text-center text-bold">Tyro Payments</h2>
      <ul class="nav nav-tabs" id="configNavigation" role="tablist">
         <li class="nav-item">
            <a class="nav-link active" id="configuration-tab" data-toggle="tab" href="#pairingContent" role="tab" aria-controls="configuration" aria-selected="true">Configuration</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" id="purchase-tab" data-toggle="tab" href="#purchaseWithTyroUIContent" role="tab" aria-controls="purchase" aria-selected="false">Purchase</a>
         </li>
         <li class="nav-item">
            <a class="nav-link" id="refund-tab" data-toggle="tab" href="#refundWithTyroUIContent" role="tab" aria-controls="refund" aria-selected="false">Refund</a>
         </li>
      </ul>
      <div class="tab-content mt-3">
         <div class="tab-pane fade show active" id="pairingContent" role="tabpanel" aria-labelledby="configuration-tab">
            <div class="row">
               <div class="col-12 col-md-6 col-lg-6 col-xl-6 p-1">
                  <h4>Configuration</h4>
                  <div class="mt-2 col-12 col-md-8">
                     <label class="form-label" for="mid">Merchant ID:</label>
                     <input id="mid" type="text" class="form-control" placeholder="Merchant ID" name="mid">
                  </div>
                  <div class="mt-2 col-12 col-md-8">
                     <label class="form-label" for="tid">Terminal ID:</label>
                     <input id="tid" type="text" class="form-control" placeholder="Terminal ID" name="tid">
                  </div>
                  <div class="d-flex mt-2 col-12 col-md-8 justify-content-center align-items-center">
                     <button type="button" class="btn btn-lg btn-primary" onclick="doPairing()">Commence Pairing</button>
                  </div>
               </div>
               <div class="col-12 col-md-6 col-lg-6 col-xl-6">
                  <div class="border border-light p-1" style="height: 200px;">
                     <h4>Messages</h4>
                     <div id="messages"></div>
                  </div>
                  <div class="border border-light p-1" style="height: 200px;">
                     <h4>Result</h4>
                     <div id="pair_result"></div>
                  </div>
               </div>
            </div>
         </div>
         <div class="tab-pane fade" id="purchaseWithTyroUIContent" role="tabpanel" aria-labelledby="purchase-tab">
            <div class="row">
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Purchase</h4>
                  <div class="form-group m-2">
                     <label class="form-label" for="amount">Amount:</label>
                     <input id="amount" type="text" class="form-control" placeholder="Amount" name="amount" value="100">
                  </div>
                  <div class="form-group m-2">
                     <label class="form-label" for="cashout">Cash out:</label>
                     <input id="cashout" type="text" class="form-control" placeholder="Cash out" name="cashout" value="0">
                  </div>
                  <div class="form-group m-2 d-flex justify-content-center align-items-center">
                     <button type="button" class="btn btn-lg btn-primary" onclick="doPurchaseWithTyroUI()">Process</button>
                  </div>
               </div>
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Result</h4>
                  <div id="result"></div>
               </div>
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Merchant Receipt</h4>
                  <div id="merchantReceipt" style="width: 250px;"></div>
               </div>
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Customer Receipt</h4>
                  <div id="customerReceipt" style="width: 250px;"></div>
               </div>
            </div>
         </div>
         <div class="tab-pane fade" id="refundWithTyroUIContent" role="tabpanel" aria-labelledby="refund-tab">
            <div class="row">
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Refund</h4>
                  <div class="form-group m-2">
                     <label class="form-label" for="refund_amount">Refund Amount:</label>
                     <input id="refund_amount" type="text" class="form-control" placeholder="Amount" name="refund_amount" value="">
                  </div>
                  <div class="form-group m-2 d-flex justify-content-center align-items-center">
                     <button type="button" class="btn btn-lg btn-primary" onclick="doRefundWithTyroUI()">Process</button>
                  </div>
               </div>
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Result</h4>
                  <div id="refund_result"></div>
               </div>
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Merchant Receipt</h4>
                  <div id="refund_merchantReceipt" style="width: 250px;"></div>
               </div>
               <div class="col-12 col-md-3 col-lg-3 col-xl-3 p-1">
                  <h4>Customer Receipt</h4>
                  <div id="refund_customerReceipt" style="width: 250px;"></div>
               </div>
            </div>
         </div>
      </div>
   </main>

   <script src="https://iclientsimulator.test.tyro.com/iclient-with-ui-v1.js"></script>
   <script>
      var apiKey = "8a28a6421856b38d22f46ad0b4721ab1";
      var tid;
      var mid;
      const posProductInfo = {
         posProductVendor: "Foodship",
         posProductName: "Foodship POS",
         posProductVersion: "1.0.7",
      };
      var integrationKey;

      function setConfig(params) {
         apiKey = params.apiKey;
         mid = params.mid;
         tid = params.tid;
         posProductInfo = params.posProductInfo;
         terminalStatus = 1;
         document.getElementById("mid").value = params.mid;
         document.getElementById("tid").value = params.tid;
         document.getElementById("type").value = params.type;
         document.getElementById("amount").value = params.amount;
      }

      function sendResponse(params) {
         alert(params, "llll")
         params = JSON.stringify(params);
         if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
            window.ReactNativeWebView.postMessage(params);
         }
      }

      async function onWebViewMessage(message) {
         try {
            if (!message === undefined || message === null || message === '') return;
            if (!message.data) return;

            const res = JSON.parse(message.data);
            console.log(res)
            if (res.action === 'set-config') {
               setConfig(res.data);
            }
            if (res.action === 'init-purchase') {
               document.getElementById("amount").value = res.data.amount;
               document.getElementById("cashout").value = res.data.cashout;
               document.getElementById("type").value = res.data.type;
               doPurchaseWithTyroUI();
            }
         } catch (error) {
            alert('Error', error.message)
         }
      }

      window.addEventListener("message", (message) => onWebViewMessage(message), false);

      async function doPairing() {
         integrationKey = await Tyro.commencePairing(apiKey, mid, tid, posProductInfo, displayPairingMessages, displayPairingResult);
      }

      function displayPairingMessages(message) {
         console.log("Pairing Message:", message);
         document.getElementById("messages").innerText = JSON.stringify(message, null, 2);
      }

      function displayPairingResult(result) {
         console.log("Pairing Result:", result);
         document.getElementById("pair_result").innerText = JSON.stringify(result, null, 2);
      }

      async function doPurchaseWithTyroUI() {
         const type = document.getElementById("type").value || "purchase";
         const amount = document.getElementById("amount").value;
         const cashout = document.getElementById("cashout").value;
         const result = await Tyro[type](integrationKey, amount, cashout);
         console.log("Purchase Result:", result);
         sendResponse(result);
         displayResult(result);
      }

      function displayResult(result) {
         console.log("Transaction Result:", result);
         document.getElementById("result").innerText = JSON.stringify(result, null, 2);
         displayReceipts(result.receipts);
      }

      function displayReceipts(receipts) {
         if (receipts) {
            document.getElementById("merchantReceipt").innerText = receipts.merchantReceipt || "";
            document.getElementById("customerReceipt").innerText = receipts.customerReceipt || "";
         }
      }

      async function doRefundWithTyroUI() {
         const type = document.getElementById("type").value || "refund";
         const amount = document.getElementById("refund_amount").value;
         const result = await Tyro[type](integrationKey, amount);
         console.log("Refund Result:", result);
         sendResponse(result);
         displayRefundResult(result);
      }

      function displayRefundResult(result) {
         console.log("Refund Transaction Result:", result);
         document.getElementById("refund_result").innerText = JSON.stringify(result, null, 2);
         displayRefundReceipts(result.receipts);
      }

      function displayRefundReceipts(receipts) {
         if (receipts) {
            document.getElementById("refund_merchantReceipt").innerText = receipts.merchantReceipt || "";
            document.getElementById("refund_customerReceipt").innerText = receipts.customerReceipt || "";
         }
      }
   </script>
</body>

</html>
